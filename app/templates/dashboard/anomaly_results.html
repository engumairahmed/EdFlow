{% extends 'dashboard/base.html' %}

{% block title %}Anomaly Detection Results{% endblock %}

{% block page_heading %}Anomaly Detection{% endblock %}

{% block content %}
<div class="anomaly-results-container">

    <div class="dashboard-card animated-fade-in delay-0">
        <h3 class="card-title"><i class="fas fa-file-csv icon-purple"></i> Select Data File for Anomaly Detection</h3>
        <p class="card-description">Choose a CSV or XLSX file from your uploaded data to analyze for anomalies.</p>
        <form method="POST" action="{{ url_for('dashboard.anomaly_results_view') }}" class="file-selection-form">
            <div class="form-group">
                <label for="file_select">Select a Data File:</label>
                <select name="file_select" id="file_select" class="form-control">
                    {% if all_files %}
                        <option value="">-- Choose a file --</option>
                        {% for file in all_files %}
                            <option value="{{ file }}" {% if selected_file == file %}selected{% endif %}>{{ file }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="">No CSV/XLSX files found in 'uploads' folder.</option>
                    {% endif %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-play-circle"></i> Run Anomaly Detection on File</button>
        </form>
    </div>

    <div class="dashboard-card animated-fade-in delay-1">
        <h3 class="card-title"><i class="fas fa-database icon-purple"></i> Run Anomaly Detection on Live Database</h3>
        <p class="card-description">Perform anomaly analysis on the live student data from your MongoDB database.</p>
        <form method="POST" action="{{ url_for('dashboard.anomaly_results_view') }}">
            <input type="hidden" name="run_db_scan" value="true">
            <button type="submit" class="btn btn-secondary mt-3"><i class="fas fa-database"></i> Run Anomaly Detection on Database</button>
        </form>
    </div>

    {% if results_source %}
        <div class="dashboard-card animated-fade-in delay-2">
            <h3 class="card-title"><i class="fas fa-chart-pie icon-purple"></i> Anomaly Overview Visualizations</h3>
            <p class="card-description">Visual representation of anomalies. (Source: {{ results_source | title }})</p>
            <div class="charts-grid">
                <div class="chart-container-small">
                    <h4>Anomalies by Gender</h4>
                    <canvas id="genderAnomalyChart"></canvas>
                </div>
                <div class="chart-container-small">
                    <h4>Anomaly Score Distribution</h4>
                    <canvas id="scoreDistributionChart"></canvas>
                </div>
            </div>
            <div class="insights mt-3">
                <h5>Key Anomaly Insights:</h5>
                <ul>
                    <li>{{ anomaly_insights.gender_insight | default("No specific gender-based anomaly insights.") }}</li>
                    <li>{{ anomaly_insights.score_insight | default("Anomaly scores show a concentration around the detection threshold.") }}</li>
                </ul>
            </div>
        </div>

        {% if anomalous_students %}
        <div class="dashboard-card animated-fade-in delay-3">
            <h3 class="card-title">
                <i class="fas fa-exclamation-triangle icon-purple"></i>
                Anomalous Students (Total: {{ anomalous_students | length }} out of {{ total_students }})
            </h3>
            <p class="card-description">Detected students with unusual patterns from the {{ results_source }} data.</p>
            <div class="table-responsive">
                <table id="anomalyDataTable" class="display data-table" style="width:100%">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Anomaly Score</th>
                            <th>Extreme Features</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in anomalous_students %}
                        <tr>
                            <td>{{ student.studentID | default(student.student_id) }}</td>
                            <td>{{ student.student_name | default("N/A") }}</td>
                            <td>{{ student.anomaly_score }}</td>
                            <td>
                                {% if results_source == "file" %}
                                    <ul>
                                    {% for feature, data in student.extreme_features.items() %}
                                        <li><strong>{{ feature | replace('_', ' ') | title }}:</strong> {{ data.value }} ({{ data.description }})</li>
                                    {% endfor %}
                                    </ul>
                                {% else %}
                                    <pre>{{ student.ml_features | tojson(indent=2) }}</pre>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% else %}
        <div class="dashboard-card animated-fade-in delay-2">
            <h3 class="card-title"><i class="fas fa-check-circle icon-green"></i> No Anomalies Detected</h3>
            <p class="card-description">The system did not find any significant anomalies in the {{ results_source }} data.</p>
        </div>
        {% endif %}
    {% endif %}

</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof jQuery != 'undefined') {
            $('#anomalyDataTable').DataTable({
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                responsive: true
            });
        }
        const anomalyChartDataElement = document.getElementById('anomaly_chart_data_json');
        let anomalyChartData = {};
        if (anomalyChartDataElement && anomalyChartDataElement.textContent) {
            try {
                anomalyChartData = JSON.parse(anomalyChartDataElement.textContent);
            } catch (e) {
                console.error("Error parsing anomalyChartData:", e);
                anomalyChartData = {};
            }
        }
        const genderAnomalyData = {
            labels: Object.keys(anomalyChartData.gender || {}),
            datasets: [{
                data: Object.values(anomalyChartData.gender || {}),
                backgroundColor: ['#800080', '#1f9ba5', '#cccccc'],
            }]
        };
        const scoreDistributionData = {
            labels: ['<-0.5', '-0.5 to -0.2', '-0.2 to 0', '>0'],
            datasets: [{
                label: 'Number of Anomalies',
                data: [
                    (anomalyChartData.scores && anomalyChartData.scores['<-0.5']) || 0,
                    (anomalyChartData.scores && anomalyChartData.scores['-0.5 to -0.2']) || 0,
                    (anomalyChartData.scores && anomalyChartData.scores['-0.2 to 0']) || 0,
                    (anomalyChartData.scores && anomalyChartData.scores['>0']) || 0
                ],
                backgroundColor: ['#e74c3c', '#f39c12', '#3498db', '#2ecc71'],
                borderColor: '#fff',
                borderWidth: 1
            }]
        };

        if (document.getElementById('genderAnomalyChart')) {
            const hasGenderData = genderAnomalyData.datasets[0].data.some(val => val > 0);
            if (hasGenderData) {
                new Chart(document.getElementById('genderAnomalyChart').getContext('2d'), {
                    type: 'pie', data: genderAnomalyData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: false } } }
                });
            } else {
                document.getElementById('genderAnomalyChart').style.display = 'none';
                const chartParent = document.getElementById('genderAnomalyChart').closest('.chart-container-small');
                if (chartParent) { chartParent.innerHTML += '<p class="text-muted text-center">No gender data for anomalies.</p>'; }
            }
        }
        if (document.getElementById('scoreDistributionChart')) {
            const hasScoreData = scoreDistributionData.datasets[0].data.some(val => val > 0);
            if (hasScoreData) {
                new Chart(document.getElementById('scoreDistributionChart').getContext('2d'), {
                    type: 'bar', data: scoreDistributionData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            } else {
                document.getElementById('scoreDistributionChart').style.display = 'none';
                const chartParent = document.getElementById('scoreDistributionChart').closest('.chart-container-small');
                if (chartParent) { chartParent.innerHTML += '<p class="text-muted text-center">No score distribution data for anomalies.</p>'; }
            }
        }
    });
</script>
<div id="anomaly_chart_data_json" style="display:none;">{{ anomaly_chart_data | tojson | safe }}</div>
{% endblock %}