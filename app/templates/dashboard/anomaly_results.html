{% extends 'dashboard/base.html' %}

{% block title %}Anomaly Detection Results{% endblock %}

{% block page_heading %}Anomaly Detection{% endblock %}

{% block content %}
<div class="anomaly-results-container">

    <div class="dashboard-card animated-fade-in delay-0">
        <h3 class="card-title"><i class="fas fa-file-csv icon-purple"></i> Select Data File for Anomaly Detection</h3>
        <p class="card-description">Choose a CSV or XLSX file from your uploaded data to analyze for anomalies.</p>
        <form method="POST" action="{{ url_for('dashboard.anomaly_results_view') }}" class="file-selection-form">
            <div class="form-group">
                <label for="file_select">Select a Data File:</label>
                <select name="file_select" id="file_select" class="form-control">
                    {% if all_files %}
                    <option value="">-- Choose a file --</option>
                    {% for file in all_files %}
                    <option value="{{ file }}" {% if selected_file==file %}selected{% endif %}>{{ file }}</option>
                    {% endfor %}
                    {% else %}
                    <option value="">No CSV/XLSX files found in 'uploads' folder.</option>
                    {% endif %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-play-circle"></i> Run Anomaly Detection
                on File</button>
            <button type="submit" name="run_db_scan" value="true" class="btn btn-secondary mt-3"><i
                    class="fas fa-database"></i> Run on Database</button>
        </form>
    </div>

    {% if anomalous_students %}
    <div class="dashboard-card animated-fade-in delay-1">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-chart-pie icon-purple"></i> Anomaly Summary ({{ results_source |
                capitalize }} Data)</h3>
            <span class="badge badge-success">Total Students: {{ total_students }}</span>
            <span class="badge badge-danger">Anomalies Found: {{ anomalous_students|length }}</span>
        </div>
        {% if anomaly_insights %}
        <div class="anomaly-insights mt-4">
            <h4 class="insights-title"><i class="fas fa-lightbulb icon-purple"></i> Key Insights:</h4>
            <ul>
                {% for key, insight in anomaly_insights.items() %}
                <li><strong>{{ key.replace('_', ' ').title() }}:</strong> {{ insight }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

            {% if anomalous_students %}
<div class="dashboard-card animated-fade-in delay-3">
    <h3 class="card-title"><i class="fas fa-chart-bar icon-purple"></i> Anomaly Visualizations</h3>
    <div id="anomalyBarChart" style="width: 100%; height: 400px;"></div>
    <div id="featurePieChart" style="width: 100%; height: 400px; margin-top: 30px;"></div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<!-- <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Data from backend
        const studentIds = {{ chart_data.student_ids | tojson }};
        const anomalyScores = {{ chart_data.anomaly_scores | tojson }};
        const featureCounts = {{ chart_data.feature_counts | tojson }};

        // Bar Chart: Anomaly Scores per Student
        const barData = [{
            x: studentIds,
            y: anomalyScores,
            type: 'bar',
            marker: { color: 'rgba(222,45,38,0.8)' }
        }];

        const barLayout = {
            title: 'Anomaly Scores of Students',
            xaxis: { title: 'Student ID' },
            yaxis: { title: 'Anomaly Score' }
        };

        Plotly.newPlot('anomalyBarChart', barData, barLayout);

        // Pie Chart: Extreme Features Distribution
        const pieLabels = Object.keys(featureCounts);
        const pieValues = Object.values(featureCounts);

        const pieData = [{
            labels: pieLabels,
            values: pieValues,
            type: 'pie',
            textinfo: 'label+percent',
            insidetextorientation: 'radial'
        }];

        const pieLayout = {
            title: 'Extreme Features Distribution'
        };

        Plotly.newPlot('featurePieChart', pieData, pieLayout);
    });
</script> -->















<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Data from backend safely injected using | tojson
        const studentIds = JSON.parse('{{ chart_data.student_ids | tojson | safe }}');
        const anomalyScores = JSON.parse('{{ chart_data.anomaly_scores | tojson | safe }}');
        const featureCounts = JSON.parse('{{ chart_data.feature_counts | tojson | safe }}');

        // Bar Chart: Anomaly Scores per Student
        const barData = [{
            x: studentIds,
            y: anomalyScores,
            type: 'bar',
            marker: { color: 'rgba(222,45,38,0.8)' }
        }];

        const barLayout = {
            title: 'Anomaly Scores of Students',
            xaxis: { title: 'Student ID' },
            yaxis: { title: 'Anomaly Score' }
        };

        Plotly.newPlot('anomalyBarChart', barData, barLayout);

        // Pie Chart: Extreme Features Distribution
        const pieLabels = Object.keys(featureCounts);
        const pieValues = Object.values(featureCounts);

        const pieData = [{
            labels: pieLabels,
            values: pieValues,
            type: 'pie',
            textinfo: 'label+percent',
            insidetextorientation: 'radial'
        }];

        const pieLayout = {
            title: 'Extreme Features Distribution'
        };

        Plotly.newPlot('featurePieChart', pieData, pieLayout);
    });
</script>















{% endif %}












    </div>

    <div class="dashboard-card animated-fade-in delay-2">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-user-times icon-purple"></i> List of Anomalous Students</h3>
        </div>
        <div class="table-responsive">
            <table id="anomalyDataTable" class="display data-table" style="width:100%">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Student Name</th>
                        <th>Anomaly Score</th>
                        <th>Extreme Features</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in anomalous_students %}
                    <tr>
                        <td>{{ student.studentID | default(student.student_id) }}</td>
                        <td>{{ student.student_name | default("N/A") }}</td>
                        <td>{{ student.anomaly_score }}</td>
                        <td>
                            {% if results_source == "file" %}
                            <ul>
                                {% for feature, data in student.extreme_features.items() %}
                                <li><strong>{{ feature | replace('_', ' ') | title }}:</strong> {{ data.value }} ({{
                                    data.description }})</li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <pre>{{ student.ml_features | tojson(indent=2) }}</pre>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
    {% else %}
    <div class="dashboard-card animated-fade-in delay-1">
        <h3 class="text-center text-muted">No anomaly detection results to display.</h3>
        <p class="text-center text-muted">Please select a file from the list above or run a scan on the database.</p>
    </div>
    {% endif %}

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof jQuery != 'undefined') {
            $('#anomalyDataTable').DataTable({
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                responsive: true
            });
        }

        // --- Student Details Modal ---
        const modal = document.getElementById("studentDetailsModal");
        const closeButton = document.querySelector(".close-button");
        const modalContentDiv = document.getElementById("modalContent");
        const modalStudentId = document.getElementById("modalStudentId");

        window.showStudentDetails = function (student) {
            modalStudentId.textContent = `Student Details: ${student.student_id}`;
            let detailsHtml = '<ul>';
            for (const key in student) {
                if (key === 'anomaly_score' || key === 'extreme_features' || key === 'is_anomaly') {
                    continue;
                }
                let value = student[key];
                if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value);
                }
                detailsHtml += `<li><strong>${key.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${value}</li>`;
            }
            detailsHtml += '</ul>';
            modalContentDiv.innerHTML = detailsHtml;
            modal.style.display = "block";
        }

        if (closeButton) {
            closeButton.onclick = function () {
                modal.style.display = "none";
            }
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    });
</script>
{% endblock %}