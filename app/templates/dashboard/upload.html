{% extends "dashboard/base.html" %}

{% block title %}Upload-EdFlow{% endblock %}

{% block page_heading %}Upload Your Student Data{% endblock %}

{% block content %}
<div class="dashboard-card upload-card ">
  <h2>Upload Data File</h2>
  <p>Please upload your student data in <strong>CSV</strong> or <strong>Excel (.xlsx)</strong> format. Max file size: 100MB.</p>

  <form id="upload-form" enctype="multipart/form-data">
    <!-- Drag & Drop Area -->
    <div id="drop-area" class="upload-drop-area">
      <i class="fas fa-cloud-upload-alt upload-icon"></i>
      <p>Drag & drop your file here, or</p>
      <input type="file" id="file-input" name="dataset" accept=".csv,.xlsx" hidden>
      <label for="file-input" class="btn btn-primary browse-btn">Browse File</label>
    </div>

    <!-- File Name -->
    <div id="file-name" class="selected-file-name"></div>

    <!-- Spinner -->
    <div id="upload-spinner" style="display:none; margin-top: 10px;">
      <i class="fas fa-spinner fa-spin"></i> Preparing file...
    </div>

    <!-- Model Name Input -->
    <div id="model-name-input" style="display:none; margin-top: 15px;">
      <label for="model_name">Model Name:</label>
      <input type="text" name="model_name" id="model_name" class="form-control" required>
    </div>

    <!-- Is Paid Option -->
    <div id="is-paid-option" style="display:none; margin-top: 10px;">
      <label>
        <input type="checkbox" name="is_paid"> Make this model Paid
      </label>
    </div>

    <!-- Spinner during submission -->
    <div id="progress-container" style="display:none; margin-top: 15px; text-align: center;">
      <i class="fas fa-spinner fa-spin fa-2x" style="color: #4A148C;"></i>
      <div style="margin-top: 8px;">Processing...</div>
    </div>

    <!-- Submit Button -->
    <button type="submit" id="submit-btn" class="btn btn-success" style="display:none; margin-top: 15px;">
      <i class="fas fa-upload"></i> Train & Save Model
    </button>
  </form>
</div>

<script>
  const dropArea = document.getElementById('drop-area');
  const fileInput = document.getElementById('file-input');
  const fileName = document.getElementById('file-name');
  const spinner = document.getElementById('upload-spinner');
  const modelNameInput = document.getElementById('model-name-input');
  const isPaidOption = document.getElementById('is-paid-option');
  const submitBtn = document.getElementById('submit-btn');
  const form = document.getElementById('upload-form');
  const progressContainer = document.getElementById('progress-container');

  // Click to Browse fallback
  dropArea.addEventListener('click', () => fileInput.click());

  // Handle file selection
  fileInput.addEventListener('change', handleFile);

  // Handle drag & drop
  dropArea.addEventListener('dragover', e => {
    e.preventDefault();
    dropArea.classList.add('dragover');
  });

  dropArea.addEventListener('dragleave', e => {
    e.preventDefault();
    dropArea.classList.remove('dragover');
  });

  dropArea.addEventListener('drop', e => {
    e.preventDefault();
    dropArea.classList.remove('dragover');
    fileInput.files = e.dataTransfer.files;
    handleFile();
  });

  function handleFile() {
    const file = fileInput.files[0];
    if (file) {
      fileName.innerText = `Selected: ${file.name}`;
      spinner.style.display = 'inline-block';

      setTimeout(() => {
        spinner.style.display = 'none';
        modelNameInput.style.display = 'block';
        isPaidOption.style.display = 'block';
        submitBtn.style.display = 'inline-block';
      }, 1500);
    }
  }

  // Handle form submit using fetch
  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const dataset = fileInput.files[0];
    const modelName = document.getElementById('model_name').value;
    const isPaid = document.querySelector('input[name="is_paid"]').checked;

    if (!dataset || !modelName) {
      displayToast('Please fill all required fields.', 'error');
      return;
    }

    const formData = new FormData();
    formData.append('dataset', dataset);
    formData.append('model_name', modelName);
    formData.append('is_paid', isPaid);

    // Show spinner and hide inputs
    progressContainer.style.display = 'block';
    modelNameInput.style.display = 'none';
    isPaidOption.style.display = 'none';
    submitBtn.style.display = 'none';

    try {
      const response = await fetch('/dashboard/upload', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      displayToast(result.message, 'success');
    } catch (err) {
      displayToast('Upload failed. Please try again.', 'error');
    } finally {
      progressContainer.style.display = 'none';
    }
  });
</script>

<style>
  .upload-drop-area {
    border: 2px dashed #ccc;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: border 0.3s;
  }
  .upload-drop-area.dragover {
    border-color: #4A148C;
    background-color: #f8f8f8;
  }
  .selected-file-name {
    margin-top: 10px;
    font-weight: bold;
  }
</style>
{% endblock %}
