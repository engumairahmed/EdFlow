{% extends "dashboard/base.html" %}

{% block title %}Upload-EdFlow{% endblock %}

{% block page_heading %}Upload Your Student Data{% endblock %}

{% block content %}
<style>
  .upload-drop-area {
    border: 2px dashed #ccc;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: border 0.3s;
  }

  .upload-drop-area.dragover {
    border-color: #4A148C;
    background-color: #f8f8f8;
  }

  .selected-file-name {
    margin-top: 10px;
    font-weight: bold;
  }

  .browse-btn.disabled {
    background-color: #ccc !important;
    cursor: not-allowed;
  }

  .custom-spinner {
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    font-weight: 500;
    color: #4A148C;
  }

  .custom-spinner span {
  margin-left: 10px; /* space between spinner and text */
  font-size: 14px;
  }

  /* Dual Ring Loader */
  .lds-dual-ring {
    display: inline-block;
    width: 24px;
    height: 24px;
  }

  .lds-dual-ring:after {
    content: " ";
    display: block;
    width: 24px;
    height: 24px;
    margin: 0;
    border-radius: 50%;
    border: 3px solid #4A148C;
    border-color: #4A148C transparent #4A148C transparent;
    animation: lds-dual-ring 1.2s linear infinite;
  }

  @keyframes lds-dual-ring {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .ripple-loader {
  display: inline-block;
  position: relative;
  width: 80px;
  height: 80px;
}

.ripple-loader div {
  position: absolute;
  border: 4px solid #6A0DAD; /* Vibrant purple */
  border-radius: 50%;
  animation: ripple 1.5s cubic-bezier(0, 0.2, 0.8, 1) infinite;
}

.ripple-loader div:nth-child(2) {
  animation-delay: -0.75s;
}

@keyframes ripple {
  0% {
    top: 36px;
    left: 36px;
    width: 0;
    height: 0;
    opacity: 1;
  }
  100% {
    top: 0px;
    left: 0px;
    width: 72px;
    height: 72px;
    opacity: 0;
  }
}

</style>
<div class="dashboard-card upload-card ">
  <h2>Upload Data File</h2>
  <p>Please upload your student data in <strong>CSV</strong> or <strong>Excel (.xlsx)</strong> format. Max file size:
    100MB.</p>

  <form id="upload-form" enctype="multipart/form-data">
    <!-- Drag & Drop Area -->
    <div id="drop-area" class="upload-drop-area">
      <i class="fas fa-cloud-upload-alt upload-icon"></i>
      <p>Drag & drop your file here, or</p>
      <input type="file" id="file-input" name="dataset" accept=".csv,.xlsx" hidden>
      <label for="file-input" class="btn btn-primary browse-btn">Browse File</label>
    </div>

    <!-- File Name -->
    <div id="file-name" class="selected-file-name"></div>

    <!-- Spinner -->
    <div id="upload-spinner" class="custom-spinner" style="display:none;">
      <div class="lds-dual-ring"></div>
      <span>Preparing file...</span>
    </div>

    <!-- Model Name Input -->
    <div id="model-name-input" style="display:none; margin-top: 15px;">
      <label for="model_name">Model Name:</label>
      <input type="text" name="model_name" id="model_name" class="form-control" required>
    </div>

    <!-- Is Paid Option -->
    <div id="is-paid-option" style="display:none; margin-top: 10px;">
      <label>
        <input type="checkbox" name="is_paid"> Make this model Paid
      </label>
    </div>

    <!-- Spinner during submission -->
    <div id="progress-container" style="display:none; margin-top: 15px; text-align: center;">
      <div class="ripple-loader">
        <div></div>
        <div></div>
      </div>
      <div style="margin-top: 8px;">Processing...</div>
    </div>

    <!-- Submit Button -->
    <button type="submit" id="submit-btn" class="btn btn-success" style="display:none; margin-top: 15px;">
      <i class="fas fa-upload"></i> Train & Save Model
    </button>
  </form>
</div>

<script>
  const dropArea = document.getElementById('drop-area');
  const fileInput = document.getElementById('file-input');
  const fileName = document.getElementById('file-name');
  const spinner = document.getElementById('upload-spinner');
  const modelNameInput = document.getElementById('model-name-input');
  const isPaidOption = document.getElementById('is-paid-option');
  const submitBtn = document.getElementById('submit-btn');
  const form = document.getElementById('upload-form');
  const progressContainer = document.getElementById('progress-container');

  // Click to Browse fallback
  dropArea.addEventListener('click', () => fileInput.click());

  // Handle file selection
  fileInput.addEventListener('change', handleFile);

  // Handle drag & drop
  dropArea.addEventListener('dragover', e => {
    e.preventDefault();
    dropArea.classList.add('dragover');
  });

  dropArea.addEventListener('dragleave', e => {
    e.preventDefault();
    dropArea.classList.remove('dragover');
  });

  dropArea.addEventListener('drop', e => {
    e.preventDefault();
    dropArea.classList.remove('dragover');
    fileInput.files = e.dataTransfer.files;
    handleFile();
  });

  function handleFile() {
    const file = fileInput.files[0];
    if (file) {
      fileName.innerText = `Selected: ${file.name}`;
      spinner.style.display = 'inline-block';

      setTimeout(() => {
        spinner.style.display = 'none';
        modelNameInput.style.display = 'block';
        isPaidOption.style.display = 'block';
        submitBtn.style.display = 'inline-block';
      }, 1500);
    }
  }

  // Handle form submit using fetch
  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    progressContainer.style.display = 'block';
    document.querySelector('.browse-btn').classList.add('disabled');
    dropArea.style.pointerEvents = 'none';
    dropArea.style.opacity = '0.6';


    const dataset = fileInput.files[0];
    const modelName = document.getElementById('model_name').value;
    const isPaid = document.querySelector('input[name="is_paid"]').checked;

    if (!dataset || !modelName) {
      displayToast('Please fill all required fields.', 'error');
      return;
    }

    const formData = new FormData();
    formData.append('dataset', dataset);
    formData.append('model_name', modelName);
    formData.append('is_paid', isPaid);

    // Show spinner and hide inputs
    progressContainer.style.display = 'block';
    modelNameInput.style.display = 'none';
    isPaidOption.style.display = 'none';
    submitBtn.style.display = 'none';

    try {
      const response = await fetch('/dashboard/upload', {
        method: 'POST',
        body: formData
      });
      const result = await response.json();
      displayToast(`${modelName} trained and saved successfully`, 'success');
      progressContainer.style.display = 'none';
      document.querySelector('.browse-btn').style.pointerEvents = 'auto';
      dropArea.style.pointerEvents = 'auto';
      dropArea.style.opacity = '1';
      document.querySelector('.browse-btn').classList.remove('disabled');
    } catch (err) {
      displayToast('Upload failed. Please try again.', 'error');
    } finally {
      progressContainer.style.display = 'none';
    }
  });
</script>
{% endblock %}