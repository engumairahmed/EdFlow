{% extends 'dashboard/base.html' %}

{% block title %}Predict-EdFlow{% endblock %}

{% block page_heading %}Update Student Information{% endblock %}

{% block content %}

<div class="prediction-container">
    <div class="prediction-input-card dashboard-card ">
        <h2><i class="fas fa-edit icon-purple"></i> Enter Student Details</h2>
        <p>Input the student's academic and personal information to get a prediction of their future outcome. Please
            fill in all the required fields accurately.</p>
        {# Removed the `{{ result }}` here, as it's not standard Jinja2 usage for displaying a whole object. #}

        <form id="predictionForm" class="prediction-form" method="post" action="/teacher/update_student">
            <div class="form-grid">
                <div class="form-group">
                    <label for="studentName">Student Name:</label>
                    <input type="text" id="studentName" name="studentName" placeholder="e.g., Ali Khan" required>
                </div>
                <div class="form-group">
                    <label for="age">Age:</label>
                    <input type="number" id="age" name="age" placeholder="e.g., 18" required>
                </div>

                <div class="form-group">
                    <label for="gender">Gender:</label>
                    <select id="gender" name="gender" required>
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="parental_education">Parental Education:</label>
                    <select id="parental_education" name="parental_education" required>
                        <option value="">Select Option</option>
                        <option value="none">None</option>
                        <option value="high school">High School</option>
                        <option value="bachelors">Bachelors</option>
                        <option value="masters">Masters</option>
                        <option value="phd">PhD</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="currentGPA">Current GPA (0.0-4.0):</label>
                    <input type="number" id="currentGPA" name="currentGPA" step="0.01" min="0" max="4" placeholder="e.g., 3.5"
                        required>
                </div>
                <div class="form-group">
                    <label for="exam_score">Exam Score:</label>
                    <input type="number" id="exam_score" name="exam_score" min="0" max="100" placeholder="e.g., 95"
                        required>
                </div>

                <div class="form-group">
                    <label for="highSchoolGPA">High School GPA (0.0-4.0):</label>
                    <input type="number" id="highSchoolGPA" name="highSchoolGPA" step="0.01" min="0" max="4" placeholder="e.g., 3.5"
                        required>
                </div>
                <div class="form-group">
                    <label for="attendance">Attendance Rate (%):</label>
                    <input type="number" id="attendance" name="attendance" min="0" max="100" placeholder="e.g., 95"
                        required>
                </div>

                <div class="form-group">
                    <label for="social_media_hours">Social Media Hours/day:</label>
                    <input type="number" id="social_media_hours" name="social_media_hours" step="0.01"
                        placeholder="e.g., 5" required>
                </div>
                <div class="form-group">
                    <label for="netflix_hours">Netflix Hours/day:</label>
                    <input type="number" id="netflix_hours" name="netflix_hours" min="0" max="100" placeholder="e.g., 2"
                        required>
                </div>

                <div class="form-group">
                    <label for="diet_quality">Diet Quality:</label>
                    <select id="diet_quality" name="diet_quality" required>
                        <option value="">Select Option</option>
                        <option value="poor">Poor</option>
                        <option value="average">Average</option>
                        <option value="good">Good</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="exercise_frequency">Exercise Frequency:</label>
                    <select id="exercise_frequency" name="exercise_frequency" required>
                        <option value="">Select Option</option>
                        <option value="low">Low</option>
                        <option value="moderate">Moderate</option>
                        <option value="high">High</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sleep_hours">Sleep Hours/night:</label>
                    <input type="number" id="sleep_hours" name="sleep_hours" step="0.01" placeholder="e.g., 7.5"
                        required>
                </div>
                <div class="form-group">
                    <label for="internet_quality">Internet Quality:</label>
                    <select id="internet_quality" name="internet_quality" required>
                        <option value="">Select Option</option>
                        <option value="poor">Poor</option>
                        <option value="average">Average</option>
                        <option value="good">Good</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mental_health_score">Mental Health Score (1-100):</label>
                    <input type="number" id="mental_health_score" name="mental_health_score" step="0.01"
                        placeholder="e.g., 7" required>
                </div>
                <div class="form-group">
                    <label for="part_time_job">Part Time Job:</label>
                    <select id="part_time_job" name="part_time_job" required>
                        <option value="">Select Option</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="extracurriculars">Extracurricular Activities:</label>
                    <select id="extracurriculars" name="extracurricular_activities" required>
                        <option value="">Select Option</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="supportNeeded">Support Needed:</label>
                    <select id="supportNeeded" name="supportNeeded" required>
                        <option value="">Select Option</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="familySupport">Family Support Level:</label>
                    <select id="familySupport" name="familySupport" required>
                        <option value="">Select Level</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="studyHours">Daily Study Hours:</label>
                    <input type="number" id="studyHours" name="study_hours" min="0" placeholder="e.g., 15" required>
                </div>
                <div class="form-group">
                    <label for="model">Prediction Model:</label>
                    <select id="model" name="model" required>
                        <option value="none">Select Model</option>
                            {% for model_group in available_models %}
                            {% for detail in model_group.details %}
                            {% if detail.type in ['classification'] %}
                            <option value="{{ detail.model_path }}">
                                Type: {{ detail.model_name | replace("_", " ") | title }} |
                                Dataset: {{ model_group.dataset }} |
                                Acc: {{ "%.2f"|format(detail.metrics.accuracy * 100) }}%
                                {% if model_group.is_paid %} ðŸ”’ Premium {% endif %}
                            </option>
                            {% endif %}
                            {% endfor %}
                            {% endfor %}
                    </select>
                </div>
            </div>

            <button type="submit" class="btn btn-primary predict-btn"><i class="fas fa-flask"></i> Predict
                Outcome</button>
        </form>
        {# REMOVED THIS REDUNDANT BLOCK WHICH WAS LIKELY CAUSING THE ERROR #}
        {# <div>
            {% if prediction %}
            <p><strong>Predicted Outcome:</strong> {{ prediction }}</p>
            {% for result in prediction%}
            <p>{{ result }}</p>
            {%endfor%}
            {% endif %}
        </div> #}
    </div>

    {# The prediction results card should initially be hidden and shown by JavaScript #}
    <div id="predictionResults" class="prediction-results-card dashboard-card" style="display: none;">
        <h2><i class="fas fa-chart-pie icon-purple"></i> Prediction Results</h2>
        <div class="result-details">
            <p><strong>Predicted Outcome:</strong> <span id="predictedOutcome" class="outcome-label"></span></p>
            <p><strong>Confidence Level:</strong> <span id="confidenceLevel"></span></p>
        </div>

        <div class="prediction-chart-container">
            <canvas id="predictionChart"></canvas>
        </div>

        <div class="recommendations-section">
            <h3><i class="fas fa-lightbulb"></i> Recommendations</h3>
            <p id="recommendationsText">Based on the prediction, personalized recommendations will appear here to help
                improve student outcomes.</p>
        </div>
    </div>

    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> Predicting...
    </div>

    <div id="messageArea" class="message-area"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const predictionForm = document.getElementById('predictionForm');
    const predictionResults = document.getElementById('predictionResults');
    const predictedOutcomeSpan = document.getElementById('predictedOutcome');
    const confidenceLevelSpan = document.getElementById('confidenceLevel');
    const recommendationsText = document.getElementById('recommendationsText');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const messageArea = document.getElementById('messageArea');
    let predictionChartInstance = null; // To store Chart.js instance


    // Function to render/update the Chart.js pie chart
    function updatePredictionChart(dropoutProbability) {
        const ctx = document.getElementById('predictionChart').getContext('2d');

        // Destroy existing chart if it exists
        if (predictionChartInstance) {
            predictionChartInstance.destroy();
        }

        const noDropoutProbability = (1 - dropoutProbability); // Calculate no-dropout probability
        const dropoutProbPercent = (dropoutProbability * 100).toFixed(2);
        const noDropoutProbPercent = (noDropoutProbability * 100).toFixed(2);

        const labels = ['Dropout', 'No Dropout'];
        const values = [parseFloat(dropoutProbPercent), parseFloat(noDropoutProbPercent)]; // Ensure they are numbers
        const backgroundColors = [
            'rgba(255, 99, 132, 0.7)', // Red for Dropout
            'rgba(75, 192, 192, 0.7)'  // Green for No Dropout
        ];
        const borderColors = [
            'rgba(255, 99, 132, 1)',
            'rgba(75, 192, 192, 1)'
        ];

        predictionChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#4c4c4c', // Match text-color
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed + '%'; // Values are already percentages
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // Handle form submission
    predictionForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // Prevent default form submission

        loadingIndicator.style.display = 'block';
        messageArea.innerHTML = ''; // Clear previous messages
        predictionResults.style.display = 'none'; // Hide results until new prediction

        const formData = new FormData(predictionForm);
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });

        try {
            const response = await fetch('/dashboard/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                displayToast('Prediction successful!', 'success');
                // Determine predicted outcome text and styling based on prediction_class
                let outcomeText = '';
                let outcomeClass = '';
                console.log(result.prediction_class)
                if (result.prediction_class === 1) { // Assuming 1 means dropout
                    outcomeText = 'Student is predicted to Dropout';
                    outcomeClass = 'outcome-at-risk';
                } else { // Assuming 0 means no dropout
                    outcomeText = 'Student is predicted to NOT Dropout';
                    outcomeClass = 'outcome-success';
                }

                predictedOutcomeSpan.textContent = outcomeText;
                confidenceLevelSpan.textContent = `${(result.prediction_probability * 100).toFixed(2)}%`; // Format as percentage
                recommendationsText.textContent = result.recommendations || 'No specific recommendations at this time.';

                predictedOutcomeSpan.className = 'outcome-label ' + outcomeClass;

                // Update the chart using the single prediction_probability value
                updatePredictionChart(result.prediction_probability);

                predictionResults.style.display = 'block';
                displayToast('Prediction successful!', 'success');
            } else {
                displayToast(result.message || 'An error occurred during prediction.', 'error');
            }
        } catch (error) {
            console.error('Prediction request failed:', error);
            console.log(error)
            displayToast('Network error or server issue. Please try again.', 'error');
        } finally {
            loadingIndicator.style.display = 'none';
        }
    });

    // Initial load animations
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.prediction-input-card').classList.add('animated-slide-in-up');
    });
</script>
{% endblock %}