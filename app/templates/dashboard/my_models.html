{% extends 'dashboard/base.html' %}

{% block title %}Trained-model EdFlow{% endblock %}

{% block page_heading %}Trained Models{% endblock %}

{% block content %}

    <div class="page-header">
        <h1>My Models</h1>
        <a href="#" class="btn btn-primary">Upload New Model</a>
    </div>

    <div class="filters-sort">
        <input type="text" class="search-input" placeholder="Search my models...">
        <div class="filter-group">
            <label for="status-filter">Status:</label>
            <select id="status-filter">
                <option value="all">All</option>
                <option value="published">Published</option>
                <option value="draft">Draft</option>
                <option value="review">Under Review</option>
                <option value="archived">Archived</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="sort-by">Sort By:</label>
            <select id="sort-by">
                <option value="date-desc">Date (Newest)</option>
                <option value="date-asc">Date (Oldest)</option>
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
            </select>
        </div>
    </div>
    
    {% if models %}
    <div class="model-grid" id="model-grid-container">
        {% for model_group in models %}
            {% for detail in model_group.details %}
                <div class="model-card" 
                     data-name="{{ detail.model_name }}" 
                     data-date="{{ model_group.created_at.strftime('%Y-%m-%d') }}"
                     data-status="published">
                    <div class="model-card-content">
                        <h3>Model: {{ model_group.dataset }}</h3>
                        <div class="status-badge {% if detail.model_name == 'Random Forest' %}published{% elif detail.model_name == 'Logistic Regression' %}draft{% elif detail.model_name == 'Linear Regression' %}archived{% else %}review{% endif %}">
                            <span>Type: {{detail.type}}</span><br>
                            <span>Algorithm: {{detail.model_name}}</span>
                        </div>
                        <p class="model-meta">
                            Target: {{ detail.target }} | 
                            Uploaded: {{ model_group.created_at.strftime('%Y-%m-%d') }}
                        </p>
                        
                        {% if detail.type == 'Classification' %}
                            <div class="metrics-block">
                                <h5>Metrics:</h5>
                                <p><strong>Accuracy:</strong> {{ '%.2f' | format(detail.metrics.accuracy * 100) }}%</p>
                                <p><strong>Precision:</strong> {{ '%.4f' | format(detail.metrics.precision) }}</p>
                                <p><strong>Recall:</strong> {{ '%.4f' | format(detail.metrics.recall) }}</p>
                                <p><strong>F1 Score:</strong> {{ '%.4f' | format(detail.metrics.f1_score) }}</p>
                                <p><strong>ROC AUC:</strong> {{ '%.4f' | format(detail.metrics.roc_auc) }}</p>
                            </div>
                        {% elif detail.type == 'Regression' %}
                            <div class="metrics-block">
                                <h5>Metrics:</h5>
                                <p><strong>MSE:</strong> {{ '%.4f' | format(detail.metrics.mse) }}</p>
                                <p><strong>RÂ² Score:</strong> {{ '%.4f' | format(detail.metrics.r2_score) }}</p>

                            </div>
                        {% endif %}

                        <!-- <div class="model-actions">
                            <button class="action-btn">Edit</button>
                            <button class="action-btn">View</button>
                            <button class="action-btn">Delete</button>
                        </div> -->
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
    {% else %}
    <p>No models have been trained yet.</p>
    {% endif %}


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
<script src="{{ url_for('static', filename='js/datatables-simple-demo.js') }}"></script>
<script>
        document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.querySelector('.search-input');
        const statusFilter = document.getElementById('status-filter');
        const sortBy = document.getElementById('sort-by');
        const modelGrid = document.getElementById('model-grid-container');
        const modelCards = Array.from(document.querySelectorAll('.model-card'));

        function filterAndSortModels() {
            const searchQuery = searchInput.value.toLowerCase();
            const status = statusFilter.value;
            const sortValue = sortBy.value;

            let filteredCards = modelCards.filter(card => {
                const modelName = card.dataset.name.toLowerCase();
                const cardStatus = card.dataset.status;
                
                // --- UPDATED LOGIC HERE ---
                const datasetName = card.querySelector('h3').textContent.toLowerCase();
                const modelType = card.querySelector('.status-badge span:first-child').textContent.toLowerCase();
                const targetName = card.querySelector('.model-meta').textContent.toLowerCase();

                const isMatchingSearch = modelName.includes(searchQuery) ||
                                        datasetName.includes(searchQuery) ||
                                        modelType.includes(searchQuery) ||
                                        targetName.includes(searchQuery);

                const isMatchingStatus = status === 'all' || cardStatus === status;

                return isMatchingSearch && isMatchingStatus;
            });

            filteredCards.sort((a, b) => {
                const aName = a.dataset.name;
                const bName = b.dataset.name;
                const aDate = new Date(a.dataset.date);
                const bDate = new Date(b.dataset.date);
                
                if (sortValue === 'name-asc') {
                    return aName.localeCompare(bName);
                } else if (sortValue === 'name-desc') {
                    return bName.localeCompare(aName);
                } else if (sortValue === 'date-asc') {
                    return aDate - bDate;
                } else if (sortValue === 'date-desc') {
                    return bDate - aDate;
                }
                return 0;
            });

            // Update the Grid
            modelGrid.innerHTML = '';
            filteredCards.forEach(card => modelGrid.appendChild(card));
        }

        // Event Listeners
        searchInput.addEventListener('input', filterAndSortModels);
        statusFilter.addEventListener('change', filterAndSortModels);
        sortBy.addEventListener('change', filterAndSortModels);

        // Initial call to set up the grid
        filterAndSortModels();
    d});
</script>
</script>
{% endblock %}